__모든 커맨드는 root 계정에서 입력합니다__

__설치 경로: /usr/local__

1. apt update
<pre>
<code>
(echo y) | apt update
</code>
</pre>

# SoftEther VPN Client 설치
&nbsp;&nbsp;&nbsp;&nbsp;OS Version : Linux raspberrypi 5.4.51-v7l+ #1333 SMP Mon Aug 10 16:51:40 BST 2020 armv7l GNU/Linux

&nbsp;&nbsp;&nbsp;&nbsp;[다운로드 링크](https://www.softether-download.com/en.aspx?product=softether)

&nbsp;&nbsp;&nbsp;&nbsp;위 링크에서 설치 할 기기의 CPU 아키텍처에 맞는 버전의 다운로드 링크를 복사한다.

&nbsp;&nbsp;&nbsp;&nbsp;테스트 환경: ARM_EABI x32

1. 다운로드 후 압축 해제

    __라즈베리 파이 VPN 설치 경로: /usr/local__
<pre>
<code>
cd /usr/local
wget https://www.softether-download.com/files/softether/v4.34-9745-rtm-2020.04.05-tree/Linux/SoftEther_VPN_Client/32bit_-_ARM_EABI/softether-vpnclient-v4.34-9745-rtm-2020.04.05-linux-arm_eabi-32bit.tar.gz
tar xvzf softether-vpnclient-v4.34-9745-rtm-2020.04.05-linux-arm_eabi-32bit.tar.gz
rm -f softether-vpnclient-v4.34-9745-rtm-2020.04.05-linux-arm_eabi-32bit.tar.gz

</code>
</pre>

2. make (라이선스 동의 후 파일 생성)
<pre>
<code>
cd vpnclient
(echo 1; echo 1; echo 1) | make

</code>
</pre>

3. /etc/hosts 파일에 vpnserver ip 지정

    VPN 서버와 연결할 때 사용하는 ip를 지정하는 부분입니다

    아파트 모델의 경우 방재실에 설치되는 서버의 ip를 입력합니다

    만약 hosts에 vpnserver가 없어 계정 생성이 안된다면 수동으로 계정을 생성해야 합니다 ( [클라이언트설정](https://github.com/networknegineeryong/Softether-VPN-With-Dnsmasq/blob/main/2.%20SoftEther%20VPN%20Client%20config%20guide.md) )

    예를 들어 방재실 서버 ip가 192.168.0.6일 때 다음과 같이 추가하면 됩니다
<pre>
<code>
/etc/hosts
127.0.0.1       localhost
::1             localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters

127.0.1.1               raspberrypi
192.168.0.6     vpnserver
</code>
</pre>

4. SoftEther VPN Client 기본 설정

    명령어 입력 시 가상 랜카드 soft를 생성, id: client pw: client 계정이 생성되고
    
    서버와 연결, 프로그램 부팅 시 자동연결 설정이 진행된다.
<pre>
<code>
./vpnclient start
./vpnclient stop
sed -i 's/'"$bool AllowRemoteConfig false"'/'"$bool AllowRemoteConfig true"'/' vpn_client.config
./vpnclient start
cat /etc/hosts | grep vpnserver > get-dns-ip-addr
sed -i 's/'vpnserver'/''/' get-dns-ip-addr
(echo 2;echo ;echo ;echo niccreate soft; echo AccountCreate client /server:vpnserver:443 /hub:server /username:client /nicname:soft;echo AccountPasswordSet client /password:client /type:standard;echo AccountConnect client;echo AccountStartupSet client) | /usr/local/vpnclient/vpncmd
rm  get-dns-ip-addr

</code>
</pre>

# 일반 보관함일 경우
5. SoftEther VPN 클라이언트 서비스에 등록, 시작 프로그램 등록
<pre>
<code>  
echo '#!/bin/sh
[Unit]
Description=SoftEther VPN Client
After=network.target
[Service]
Type=forking
ExecStart=/usr/local/vpnclient/vpnclient start
ExecStartPost=/bin/sleep 2
ExecStartPost=/sbin/dhclient vpn_soft
ExecStop=/usr/local/vpnclient/vpnclient stop
[Install]
WantedBy=multi-user.target' > /lib/systemd/system/vpnclient.service
systemctl daemon-reload
systemctl enable vpnclient
systemctl start vpnclient
</code>
</pre>

# 아파트 모델일 경우

## 카드 리더기 인터페이스 정보 조회 방법

&nbsp;&nbsp;&nbsp;&nbsp;라즈베리 파이에 유선 랜카드를 장착해 카드 리더기를 연결하게 되면

&nbsp;&nbsp;&nbsp;&nbsp;네트워크 인터페이스가 하나 추가 되는데

&nbsp;&nbsp;&nbsp;&nbsp;추가된 인터페이스가  뭔지 모르겠다면 연결하기 전, 후 ifconfig커맨드로 정보를 비교한다.

&nbsp;&nbsp;&nbsp;&nbsp;ip 할당 전 이기 때문에 MAC주소 정보만 출력되어 있다.
<pre>
<code>
[root@localhost]# ifconfig
eth1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        ether ff:ff:ff:ff:ff:ff  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 28  bytes 3343 (3.2 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code>
</pre>

&nbsp;&nbsp;&nbsp;&nbsp;__카드리더기가 eth1으로 연결되어 있다 가정하고 작성된 코드 입니다__

&nbsp;&nbsp;&nbsp;&nbsp;__만약 eth1이 아닌 다른 인터페이스로 연결 되어 있다면 "인터페이스 설정" 이라고 강조되어 있는 부분의 코드를 수정해서 사용해야 합니다__

## DNSMASQ 설치
<pre>
<code>
apt install dnsmasq
systemctl enable dnsmasq
systemctl start dnsmasq
</code>
</pre>

1. eth1 static ip 설정  __(인터페이스 설정)__
<pre>
<code>
echo 'interface eth1
static ip_address=172.26.1.1/30' >> /etc/dhcpcd.conf
</code>
</pre>

2. dnsmasq 설정  __(인터페이스 설정)__
<pre>
<code>
echo '
interface=eth1
dhcp-range=172.26.1.2,172.26.1.2,12h
dhcp-option=option:router,172.26.1.1
dhcp-leasefile=/var/lib/dnsmasq/dnsmasq.leases
' >> /etc/dnsmasq.conf
</code>
</pre>

3. DHCP timeout 설정

    네트워크 문제로 VPN Server와 연결이 끊어졌을 때

    다시 연결을 시도하는데 기본으로 60초 동안 시도하도록 되어있다.

    그 설정을 86400초 (60일)로 변경해서 네트워크 문제가 해결된 후에도

    VPN Server와 연결을 맺도록 설정 한다.
<pre>
<code>
sed -i 's/'"#timeout 60;"'/'"timeout 86400;"'/' /etc/dhcp/dhclient.conf
</code>
</pre>

## 시스템 설정

1. SoftEther VPN 클라이언트 서비스에 등록, 시작 프로그램 등록
<pre>
<code>  
echo '#!/bin/sh
[Unit]
Description=SoftEther VPN Client
After=network.target
[Service]
Type=forking
ExecStart=/usr/local/vpnclient/vpnclient start
ExecStartPost=/bin/sleep 2
ExecStartPost=/sbin/dhclient vpn_soft
ExecStop=/usr/local/vpnclient/vpnclient stop
TimeoutSec=86400
[Install]
WantedBy=multi-user.target' > /lib/systemd/system/vpnclient.service
systemctl daemon-reload
systemctl enable vpnclient
systemctl start vpnclient

</code>
</pre>

2. ipv4 포워드 설정
<pre>
<code>
sysctl -w net.ipv4.ip_forward=1
</code>
</pre>

3. /etc/iptables-hs에 MASQUERADE추가

&nbsp;&nbsp;&nbsp;&nbsp;현재 사용중인 AP모드에 필요한 규칙이 있는 파일이다. (init.d/hs-iptables)

&nbsp;&nbsp;&nbsp;&nbsp;파일 하단에 __iptables -t nat -A POSTROUTING -o vpn_soft -j MASQUERADE__ 를 추가하면 된다.

&nbsp;&nbsp;&nbsp;&nbsp;기존의 -o eth0 -j MASQUERADE와 같이 있어도 충돌이 없는지 테스트를 통해 확인했다.

<pre>
<code>
echo '
iptables -t nat -A POSTROUTING -o vpn_soft -j MASQUERADE' >> /etc/iptables-hs
</code>
</pre>

&nbsp;&nbsp;&nbsp;&nbsp;__아파트 모델 설치 시 현장에서는 /etc/hosts 에 vpnserver 수정만 하면된다__