# VPN Client 설치 전 숙지 해야할 내용
&nbsp;

__모든 커맨드는 root 계정에서 입력합니다__

__설치 경로: /usr/local__

__사무실에서 기본 설정을 마친 후 현장 설치 시 /etc/hosts 파일에 vpnserver의 IP만 변경 혹은 추가해 주면 됩니다__ ([참고](#/etc/hosts-파일에-vpnserver-ip-지정))

&nbsp;

# 목차
[1. 사전 설정](#사전-설정)

[2. SoftEther VPN Client 설치](#softether-vpn-client-설치)

[3. /etc/hosts 파일에 vpnserver ip 지정](#/etc/hosts-파일에-vpnserver-ip-지정)

[4. SoftEther VPN Client 기본 설정](#softether-vpn-client-기본-설정)

[5. DHCP timeout 설정](#dhcp-timeout-설정)

[6. 서비스 등록](#서비스-등록)

* 카드 리더기가 없는 보관함의 경우 여기까지만 설정 합니다

[7. 카드 리더기가 있는 아파트 모델 보관함 설정](#지금-부터-나오는-설정은-카드-리더기가-있는-아파트-모델일-경우에만-사용합니다)

[8. DNSMASQ 설정](#DNSMASQ-설치)

[9. 시스템 설정](#시스템-설정)

# 사전 설정

1. apt update
<pre>
<code>apt -y update</code>
</pre>

# SoftEther VPN Client 설치
&nbsp;&nbsp;&nbsp;&nbsp;[다운로드 링크](https://www.softether-download.com/en.aspx?product=softether)

&nbsp;&nbsp;&nbsp;&nbsp;위 링크에서 설치 할 기기의 CPU 아키텍처에 맞는 버전의 다운로드 링크를 복사한다.

&nbsp;&nbsp;&nbsp;&nbsp;테스트 환경: ARM_EABI x32 (OS Version : Linux raspberrypi 5.4.51-v7l+ #1333 SMP Mon Aug 10 16:51:40 BST 2020 armv7l GNU/Linux)

- - -

1. 다운로드 후 압축 해제

    VPN 클라이언트 설치 경로: __/usr/local__

    압축 해제 시 vpnclient 파일이 생성됩니다.
<pre>
<code>cd /usr/local

wget https://www.softether-download.com/files/softether/v4.34-9745-rtm-2020.04.05-tree/Linux/SoftEther_VPN_Client/32bit_-_ARM_EABI/softether-vpnclient-v4.34-9745-rtm-2020.04.05-linux-arm_eabi-32bit.tar.gz

tar xvzf softether-vpnclient-v4.34-9745-rtm-2020.04.05-linux-arm_eabi-32bit.tar.gz

rm -f softether-vpnclient-v4.34-9745-rtm-2020.04.05-linux-arm_eabi-32bit.tar.gz</code>
</pre>

2. make (라이선스 동의 후 파일 생성)
<pre>
<code>cd vpnclient
(echo 1; echo 1; echo 1) | make</code>
</pre>

# /etc/hosts 파일에 vpnserver ip 지정

    VPN 서버와 연결할 때 사용하는 ip를 지정하는 부분입니다

    아파트 모델의 경우 방재실에 설치되는 서버의 ip를 입력합니다

    만약 hosts에 vpnserver가 없어 계정 생성이 안된다면 수동으로 계정을 생성해야 합니다 ( [클라이언트설정](https://github.com/networknegineeryong/Softether-VPN-With-Dnsmasq/blob/main/2.%20SoftEther%20VPN%20Client%20config%20guide.md) )

    예를 들어 방재실 서버 ip가 192.168.0.6일 때 다음과 같이 추가하면 됩니다
<pre>
<code>/etc/hosts
127.0.0.1       localhost
::1             localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters

127.0.1.1               raspberrypi
192.168.0.6     vpnserver</code>
</pre>

# SoftEther VPN Client 기본 설정
  
1. vpnclient 실행 후 중지 (config 파일 생성), __/usr/local/vpnclient/vpn_client.config__ 파일에서 AllowRemoteConfig false 를 true로 변경 (VPN 원격 관리 허용)
<pre>
<code>./vpnclient start

./vpnclient stop

sed -i 's/'"$bool AllowRemoteConfig false"'/'"$bool AllowRemoteConfig true"'/' vpn_client.config

./vpnclient start</code>
</pre>

2. 클라이언트 설정

<pre>
<code>[root@localhost vpnserver]# ./vpncmd

1. 2 입력

2. 아무것도 입력하지 않고 엔터

3. 아무것도 입력하지 않고 엔터

4. VPN Client> NicCreate soft [가상 랜카드 생성 {실제 생성되는 인터페이스 = vpn_soft}]
5. VPN Client> AccountCreate client /server:vpnserver:443 /hub:server /username:client /nicname:soft [연결 계정 설정 {계정명, 서버IP, 유저명, 가상 랜카드 명}]
6. VPN Client> AccountPasswordSet client /password:client /type:standard [유저 비밀번호 설정 {서버에 설정된 비밀번호와 같아야 함}]
7. VPN Client> AccountConnect client (서버에 연결)
8. VPN Client> AccountStartupSet client (부팅 시 자동 연결 설정)</code>
</pre>

* 위 계정 설정 과정을 한번에 처리하는 명령어
<pre>
<code>(echo 2;echo ;echo ;echo niccreate soft; echo AccountCreate client /server:vpnserver:443 /hub:server /username:client /nicname:soft;echo AccountPasswordSet client /password:client /type:standard;echo AccountConnect client;echo AccountStartupSet client) | /usr/local/vpnclient/vpncmd</code>
</pre>

# DHCP timeout 설정

네트워크 문제로 VPN Server와 연결이 끊어졌을 때

다시 연결을 시도하는데 기본으로 60초 동안 시도하도록 되어있다.

그 설정을 86400초 (60일)로 변경해서 네트워크 문제가 해결된 후에도 VPN Server와 연결을 맺도록 설정 한다.

__/etc/dhcp/dhclient.conf__ 파일에 #timeout 60; 주석해제 후 값 변경
<pre>
<code>sed -i 's/'"#timeout 60;"'/'"timeout 86400;"'/' /etc/dhcp/dhclient.conf</code>
</pre>

# 서비스 등록

1. SoftEther VPN 클라이언트 서비스에 등록, 시작 프로그램 등록

    __/lib/systemd/system/vpnclient.service 파일 생성 후 다음 내용 추가__
<pre>
<code>#!/bin/sh
[Unit]
Description=SoftEther VPN Client
After=network.target
[Service]
Type=forking
ExecStart=/usr/local/vpnclient/vpnclient start
ExecStartPost=/bin/sleep 2
ExecStartPost=/sbin/dhclient vpn_soft
ExecStop=/usr/local/vpnclient/vpnclient stop
TimeoutSec=86400
[Install]
WantedBy=multi-user.target</code>
</pre>

2. daemon reload, VPN Client 시작프로그램 등록, 시작
<pre>
<code>systemctl daemon-reload
systemctl enable vpnclient
systemctl start vpnclient</code>
</pre>

# 지금 부터 나오는 설정은 카드 리더기가 있는 아파트 모델일 경우에만 사용합니다

&nbsp;&nbsp;&nbsp;&nbsp;라즈베리 파이에 유선 랜카드를 장착해 카드 리더기를 연결하게 되면

&nbsp;&nbsp;&nbsp;&nbsp;네트워크 인터페이스가 하나 추가 되는데

&nbsp;&nbsp;&nbsp;&nbsp;추가된 인터페이스가  뭔지 모르겠다면 연결하기 전, 후 ifconfig커맨드로 정보를 비교한다.

&nbsp;&nbsp;&nbsp;&nbsp;ip 할당 전 이기 때문에 MAC주소 정보만 출력되어 있다.
<pre>
<code>[root@localhost]# ifconfig
eth1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        ether ff:ff:ff:ff:ff:ff  txqueuelen 1000  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 28  bytes 3343 (3.2 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</code>
</pre>

&nbsp;&nbsp;&nbsp;&nbsp;__카드리더기가 eth1으로 연결되어 있다 가정하고 작성된 코드 입니다__

&nbsp;&nbsp;&nbsp;&nbsp;__만약 eth1이 아닌 다른 인터페이스로 연결 되어 있다면 (인터페이스 설정) 이라고 강조되어 있는 부분의 코드를 수정해서 사용해야 합니다__

## DNSMASQ 설치

__만약 DNSMASQ가 설치되어 있지 않다면__
<pre>
<code>yum -y install DNSMASQ
systemctl enable DNSMASQ
systemctl start DNSMASQ</code>
</pre>

1. eth1 static ip 설정  __(인터페이스 설정)__

    __/etc/dhcpcd.conf__ 파일 하단에 다음 내용 추가
<pre>
<code>interface eth1
static ip_address=172.26.1.1/30</code>
</pre>

2. dnsmasq 설정  __(인터페이스 설정)__

    __/etc/dnsmasq.conf__ 파일 하단에 다음 내용 추가
<pre>
<code>interface=eth1
dhcp-range=172.26.1.2,172.26.1.2,12h
dhcp-option=option:router,172.26.1.1</code>
</pre>

## 시스템 설정

1. ipv4 포워드 설정
<pre>
<code>sysctl -w net.ipv4.ip_forward=1</code>
</pre>

2. __/etc/iptables-hs__ 파일에 MASQUERADE추가

    현재 사용중인 AP모드에 필요한 규칙이 있는 파일이다. (init.d/hs-iptables)

    파일 하단에 __iptables -t nat -A POSTROUTING -o vpn_soft -j MASQUERADE__ 를 추가하면 된다.
<pre>
<code>iptables -t nat -A POSTROUTING -o vpn_soft -j MASQUERADE</code>
</pre>