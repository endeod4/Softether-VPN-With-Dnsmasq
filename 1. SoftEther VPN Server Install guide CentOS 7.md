__모든 커맨드는 root 계정에서 입력합니다__

__설치 경로: /usr/local__

1. yum update
<pre>
<code>
(echo y) | yum update
</code>
</pre>

# SoftEther VPN Server 설치
&nbsp;&nbsp;&nbsp;&nbsp;[다운로드 링크](https://www.softether-download.com/en.aspx?product=softether)

&nbsp;&nbsp;&nbsp;&nbsp;위 링크에서 자신의 CPU 아키텍처와 맞는 버전의 다운로드 링크를 복사한다

&nbsp;&nbsp;&nbsp;&nbsp;테스트 환경 :Linux x64 (CentOS 7)

1. 다운로드 후 압축 해제
<pre>
<code>
cd /usr/local
wget https://www.softether-download.com/files/softether/v4.34-9745-rtm-2020.04.05-tree/Linux/SoftEther_VPN_Server/64bit_-_Intel_x64_or_AMD64/softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz
tar xvzf softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz
rm -f softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz
cd vpnserver
(echo 1; echo 1; echo 1) | make
./vpnserver start
</code>
</pre>

2. VPN Server 기본 설정 ( [수동 설정 방법](https://github.com/networknegineeryong/Softether-VPN-With-Dnsmasq/blob/main/2.%20SoftEther%20VPN%20Server%20config%20guide.md) )

    명령어를 입력하면 허브 생성, 유저 생성, (SecureNAT, NAT, DHCP)가 비활성화 되고, TAP Device가 생성된다.

    Hub: server, pw: server / User: client, pw: client
<pre>
<code>
(echo 1; echo ;echo ;echo HubCreate server /password:server;echo Hub server;echo SecurenatDisable; echo Natdisable; echo dhcpdisable; usercreate client /group: /realname:client /note: ;echo UserPasswordSet client /PASSWORD:client;echo BridgeCreate server /DEVICE:soft /TAP:yes) | /usr/local/vpnserver/vpncmd
</code>
</pre>

# DNSMASQ 설치
1. dnsmasq 설치
<pre>
<code>
yum install dnsmasq
systemctl enable dnsmasq
systemctl start dnsmasq
</code>
</pre>

2. dnsmasq 설정
<pre>
<code>
echo 'interface=tap_soft
dhcp-range=172.25.1.2,172.25.1.14,12h
dhcp-option=option:router,172.25.1.1
dhcp-leasefile=/var/lib/dnsmasq/dnsmasq.leases' >> /etc/dnsmasq.conf
</code>
</pre>

# 시스템 설정

1. VPN SERVER init.d 스크립트 등록
<pre>
<code>
echo '#!/bin/sh
# chkconfig: 2345 99 01
# Description: Enable Softether by daemon.
DAEMON=/usr/local/vpnserver/vpnserver
LOCK=/var/lock/subsys/vpnserver
TAP_ADDR=172.25.1.1

test -x $DAEMON || exit 0
case "$1" in
start)
$DAEMON start
touch $LOCK
sleep 1
/sbin/ifconfig tap_soft $TAP_ADDR/28
;;
stop)
$DAEMON stop
rm $LOCK
;;
restart)
$DAEMON stop
sleep 3
$DAEMON start
sleep 1
/sbin/ifconfig tap_soft $TAP_ADDR/28
;;
*)
echo "Usage: $0 {start|stop|restart}"
exit 1
esac
exit 0' > /etc/init.d/vpnserver
chmod +x /etc/init.d/vpnserver
chmod 755 /etc/init.d/vpnserver
chkconfig --add vpnserver
</code>
</pre>
2. daemon-reload, start
<pre>
<code>
systemctl daemon-reload
systemctl start vpnserver.service
</code>
</pre>
3. ipv4 포워딩 설정
<pre>
<code>
sysctl -w net.ipv4.ip_forward=1
</code>
</pre>
4. 포트 오픈, MASQUERADE 설정

&nbsp;&nbsp;&nbsp;&nbsp;SoftEther VPN 사용 포트: 443/TCP

&nbsp;&nbsp;&nbsp;&nbsp;Dnsmasq 사용 포트: 67/UDP
<pre>
<code>
firewall-cmd --zone=public --permanent --add-port=443/tcp
firewall-cmd --zone=public --permanent --add-port=67/udp
firewall-cmd --permanent --direct --add-rule ipv4 nat POSTROUTING 0 -j MASQUERADE
firewall-cmd --zone=trusted --add-interface=tap_soft
firewall-cmd --reload
</code>
</pre>

&nbsp;
&nbsp;
&nbsp;
&nbsp;

# 설정을 따라 했을 때 생성되는 환경

__VPN Server__

허브 명: server

비밀번호: server

유저 명: client

비밀번호: client

SecureNat, NAT, DHCP 비활성화

TAP Device 명: soft (실제 인터페이스는 tap_soft 로 표시됨)

__DNSMASQ__

DHCP 게이트 웨이: 172.25.1.1 (TAP Device 사용)

DHCP 서브넷 마스크: 172.25.1.0/28

DHCP IP 임대 범위: 172.25.1.2 - 172.25.1.14 (12시간)

__SYSTEM__

ipv4.ip_forward=1 설정 

TCP 443 포트 오픈 (SoftEther VPN 연결 요청 응답에 사용)

UDP 67 포트 오픈 (DHCP 브로드캐스트 연결 요청 응답에 사용)

MASQUERADE 설정 (VPN Client가 외부로 나갈 때 사용)