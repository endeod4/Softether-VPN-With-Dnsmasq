# VPN SERVER on CentOS 7

# 모든 커맨드는 root 계정에서 입력합니다

# 설치 경로: /usr/local

1. yum update
<pre>
<code>
yum update
</code>
</pre>

# SoftEther VPN Server 설치
&nbsp;&nbsp;&nbsp;&nbsp;[다운로드 링크](https://www.softether-download.com/en.aspx?product=softether)

&nbsp;&nbsp;&nbsp;&nbsp;위 링크에서 자신의 CPU 아키텍처와 맞는 버전의 다운로드 링크를 복사한다

&nbsp;&nbsp;&nbsp;&nbsp;테스트 환경 :Linux x64 (CentOS 7)

1. 다운로드 후 압축 해제
<pre>
<code>
cd /usr/local
wget https://www.softether-download.com/files/softether/v4.34-9745-rtm-2020.04.05-tree/Linux/SoftEther_VPN_Server/64bit_-_Intel_x64_or_AMD64/softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz
tar xvzf softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz
rm -f softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz
cd vpnserver
(echo 1; echo 1; echo 1) | make
./vpnserver start
</code>
</pre>

2. VPN Server 기본 설정 ( [수동 설정 방법](https://github.com/networknegineeryong/Softether-VPN-With-Dnsmasq/blob/main/2.%20SoftEther%20VPN%20Server%20config%20guide.md) )

    명령어를 입력하면 Hub: server, pw: server / User: client, pw:client / SecureNAT, NAT, DHCP가 비활성화 되고, TAP Device가 생성된다.
<pre>
<code>
(echo 1; echo ;echo ;echo HubCreate server /password:server;echo Hub server;echo SecurenatDisable; echo Natdisable; echo dhcpdisable; usercreate client /group: /realname:client /note: ;echo UserPasswordSet client /PASSWORD:client;echo BridgeCreate server /DEVICE:soft /TAP:yes) | /usr/local/vpnserver/vpncmd
</code>
</pre>

# DNSMASQ 설치
1. dnsmasq 설치
<pre>
<code>
yum install dnsmasq
systemctl enable dnsmasq
systemctl start dnsmasq
</code>
</pre>

2. dnsmasq 설정
<pre>
<code>
echo 'interface=tap_soft
dhcp-range=192.168.224.2,192.168.224.14,12h
dhcp-option=option:router,192.168.224.1
dhcp-leasefile=/var/lib/dnsmasq/dnsmasq.leases' >> /etc/dnsmasq.conf
</code>
</pre>

# 시스템 설정

1. VPN SERVER init.d 스크립트 등록
<pre>
<code>
echo '#!/bin/sh
# chkconfig: 2345 99 01
# Description: Enable Softether by daemon.
DAEMON=/usr/local/vpnserver/vpnserver
LOCK=/var/lock/subsys/vpnserver
TAP_ADDR=192.168.224.1

test -x $DAEMON || exit 0
case "$1" in
start)
$DAEMON start
touch $LOCK
sleep 1
/sbin/ifconfig tap_soft $TAP_ADDR/28
iptables-restore < /etc/iptables.ipv4.nat
;;
stop)
$DAEMON stop
rm $LOCK
;;
restart)
$DAEMON stop
sleep 3
$DAEMON start
sleep 1
/sbin/ifconfig tap_soft $TAP_ADDR/28
iptables-restore < /etc/iptables.ipv4.nat
;;
*)
echo "Usage: $0 {start|stop|restart}"
exit 1
esac
exit 0' > /etc/init.d/vpnserver
chmod +x /etc/init.d/vpnserver
chmod 755 /etc/init.d/vpnserver
chkconfig --add vpnserver
</code>
</pre>
2. daemon-reload, start
<pre>
<code>
systemctl daemon-reload
systemctl start vpnserver.service
</code>
</pre>
3. ipv4 포워딩 설정
<pre>
<code>
sysctl -w net.ipv4.ip_forward=1
</code>
</pre>
4. 포트 오픈, DNAT 설정
&nbsp;&nbsp;&nbsp;&nbsp;SoftEther VPN 사용 포트: 443/TCP

&nbsp;&nbsp;&nbsp;&nbsp;Dnsmasq 사용 포트: 67/UDP
<pre>
<code>
firewall-cmd --zone=public --permanent --add-port=443/tcp
firewall-cmd --zone=public --permanent --add-port=67/udp
firewall-cmd --direct --add-rule ipv4 nat PREROUTING 0 -j DNAT --to-destination 192.168.224.1
firewall-cmd --reload
</code>
</pre>