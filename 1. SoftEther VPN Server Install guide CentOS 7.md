## VPN Server 설치 전 숙지 해야할 내용
- - -

* __모든 커맨드는 root 계정에서 입력합니다__

* __SoftEther VPN Server 설치 경로: /usr/local__


* 아파트 모델 서버의 경우 __Default 게이트웨이가 VPN으로__ 설정되어야 카드 리더기 트래픽이 인터넷으로 나갈 수 있습니다

* 반대로 일반 보관함 서버의 경우 __Default 게이트웨이__ 가 __VPN이 아닌__ 기존의 __eth0__ 으로 설정이 유지되어야 합니다

* 해당 설정은 __DNSMASQ__ 설정 부분에 있으니 참고해 주세요

&nbsp;

# 목차

[1. 사전 설정](#사전-설정)

[2. SoftEther VPN Server 설치](#SoftEther-VPN-Server-설치)

[3-1. 카드 리더기가 없는 일반 보관함 서버 dnsmasq 설정](#카드-리더기가-없는-보관함-서버-dnsmasq-설정)

[3-2. 카드 리더기가 있는 아파트 보관함 서버 dnsmasq 설정](#카드-리더기가-있는-아파트-보관함-서버-dnsmasq-설정)

[4. 시스템 설정](#시스템-설정)
- - -
&nbsp;
## 사전 설정

* yum update
<pre>
<code>yum -y update</code>
</pre>
&nbsp;
## SoftEther VPN Server 설치
&nbsp;&nbsp;&nbsp;[다운로드 링크](https://www.softether-download.com/en.aspx?product=softether)

    위 링크에서 자신의 CPU 아키텍처와 맞는 버전의 다운로드 링크를 복사한다

    테스트 환경 :Linux x64 (CentOS 7)

- - -

1. 다운로드 후 압축 해제

    __VPN 서버 설치 경로: /usr/local__

    압축 해제 시 vpnserver 파일이 생성됩니다.

<pre>
<code>cd /usr/local

wget https://www.softether-download.com/files/softether/v4.34-9745-rtm-2020.04.05-tree/Linux/SoftEther_VPN_Server/64bit_-_Intel_x64_or_AMD64/softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz

tar xvzf softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz

rm -f softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x64-64bit.tar.gz</code>
</pre>

2. make (라이선스 동의 후 파일 생성)
<pre>
<code>cd vpnserver
(echo 1; echo 1; echo 1) | make</code>
</pre>

3. VPN Server 기본 설정

    __DHCP, SecureNAT, NAT__ 기능을 비활성화 하는 이유는 해당기능을 __DNSMASQ__ 로 대체해서 사용할 것이기 때문이다.

    TAP Device 명: soft (실제 인터페이스는 __tap_soft__ 로 표시된다)
<pre>
<code>[root@localhost vpnserver]# ./vpnserver start

[root@localhost vpnserver]# ./vpncmd

1. 1 입력

2. 아무것도 입력하지 않고 엔터

3. 아무것도 입력하지 않고 엔터

4. VPN Server> HubCreate server /password:server (server이름의 허브 생성, 비밀번호 server)

5. VPN Server/server> Hub server (허브 server 설정으로 진입)

6. VPN Server/server> SecurenatDisable (Securenat 비활성화)

7. VPN Server/server> NatDisable (NAT 비활성화)

8. VPN Server/server> DhcpDisable (DHCP 비활성화)

9. VPN Server/server> UserCreate client /group: /realname:client /note:  (client 이름의 유저 생성)

10. VPN Server/server> UserPasswordSet /PASSWORD:client  (유저 비밀번호 설정)

11. VPN Server/server> BridgeCreate server /DEVICE:soft /TAP:yes (TAP Device 생성)</code>
</pre>

* 위 서버 설정 과정을 한번에 처리하는 명령어
<pre>
<code>(echo 1; echo ;echo ;echo HubCreate server /password:server;echo Hub server;echo SecurenatDisable; echo Natdisable; echo dhcpdisable; usercreate client /group: /realname:client /note: ;echo UserPasswordSet client /PASSWORD:client;echo BridgeCreate server /DEVICE:soft /TAP:yes) | /usr/local/vpnserver/vpncmd</code>
</pre>

## __DNSMASQ__ 설정

* 만약 __DNSMASQ__ 가 설치되어 있지 않다면
<pre>
<code>yum -y install DNSMASQ
systemctl enable DNSMASQ
systemctl start DNSMASQ</code>
</pre>

## dnsmasq.conf 파일 수정

    /etc/dnsmasq.conf 파일 하단에 다음 내용 추가

## __카드 리더기가 있는__ 아파트 보관함 서버 dnsmasq 설정
* __VPN 클라이언트에게 게이트웨이 정보를 넘겨준다__
<pre>
<code>interface=tap_soft
dhcp-range=172.25.1.2,172.25.1.14,12h
dhcp-option=option:router,172.25.1.1</code>
</pre>

## __카드 리더기가 없는__ 보관함 서버 dnsmasq 설정
* __게이트 웨이에 잘못된 값__ 을 입력해 VPN 클라이언트에 __디폴트 게이트웨이 생성을 막는다__
<pre>
<code>interface=tap_soft
dhcp-range=172.25.1.2,172.25.1.14,12h
dhcp-option=option:router,254.254.254.254</code>
</pre>

## 시스템 설정

1. __/etc/init.d__ 에 __vpnserver__ 파일 생성
<pre>
<code>[root@localhost init.d]# touch vpnserver</code>
</pre>

2. __vpnserver__ 파일에 다음 내용 붙여넣기
<pre>
<code>#!/bin/sh
# chkconfig: 2345 99 01
# Description: Enable Softether by daemon.
DAEMON=/usr/local/vpnserver/vpnserver
LOCK=/var/lock/subsys/vpnserver
TAP_ADDR=172.25.1.1

test -x $DAEMON || exit 0
case "$1" in
start)
$DAEMON start
touch $LOCK
sleep 1
/sbin/ifconfig tap_soft $TAP_ADDR/28
;;
stop)
$DAEMON stop
rm $LOCK
;;
restart)
$DAEMON stop
sleep 3
$DAEMON start
sleep 1
/sbin/ifconfig tap_soft $TAP_ADDR/28
;;
*)
echo "Usage: $0 {start|stop|restart}"
exit 1
esac
exit 0</code>
</pre>
&nbsp;&nbsp;&nbsp;&nbsp;__DAEMON=__ VPN Server 설치 경로

&nbsp;&nbsp;&nbsp;&nbsp;__TAP_ADDR=__ eth1의 IP

3. 권한설정, chkconfig
<pre>
<code>chmod +x /etc/init.d/vpnserver
chmod 755 /etc/init.d/vpnserver
chkconfig --add vpnserver</code>
</pre>

4. daemon-reload, start
<pre>
<code>systemctl daemon-reload
systemctl start vpnserver.service</code>
</pre>

5. ipv4 포워딩 설정
<pre>
<code>sysctl -w net.ipv4.ip_forward=1</code>
</pre>

6. 포트 오픈, MASQUERADE 설정

    SoftEther VPN 사용 포트: 443/TCP

    DNSMASQ 사용 포트: 67/UDP
<pre>
<code>firewall-cmd --zone=public --permanent --add-port=443/tcp
firewall-cmd --zone=public --permanent --add-port=67/udp
firewall-cmd --permanent --direct --add-rule ipv4 nat POSTROUTING 0 -j MASQUERADE
firewall-cmd --zone=trusted --permanent --add-interface=tap_soft
firewall-cmd --reload</code>
</pre>